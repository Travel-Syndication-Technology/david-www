build:
  image: docker.infra.tstllc.net/base/ui-base-docker:latest
  pull: true
  auth_config:
    username: drone
    password: $$DRONE_REGISTRY_PASS
    email: drone@tstllc.net
  commands:
    - npm update
    - npm run build

publish:
  docker:
    repo: lib/david
    tag:
      - '$${BRANCH/master/latest}'
      - '$$BRANCH.$$BUILD_NUMBER'
    registry: docker.infra.tstllc.net
    username: drone
    password: $$DRONE_REGISTRY_PASS
    email: drone@tstllc.net
    storage_driver: overlay

deploy:
  rancher:
    url: $$RANCHER_URL
    access_key: $$RANCHER_KEY
    secret_key: $$RANCHER_SECRET
    service: npm/david-www
    docker_image: docker.infra.tstllc.net/lib/david:$$BRANCH.$$BUILD_NUMBER
    confirm: true
    timeout: 300
    when:
      branch: master

cache:
  mount:
    - node_modules